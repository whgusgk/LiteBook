<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fp.mybatis.IReportDAO">

<select id="reportlist" resultType="com.fp.dto.ReportDTO" parameterType="java.lang.String">
SELECT RNUM, REPORT_NUM, REASON, REPORT_TITLE, TYPE, WRITER, REPORT_DATE, STATUS_DATE, STATUS_STATE
FROM 
(
SELECT ROWNUM AS RNUM, DATA.*
FROM
(
SELECT T.REPORT_NUM AS REPORT_NUM, T.REASON AS REASON, T.REPORT_TITLE AS REPORT_TITLE, T.TYPE AS TYPE
, T.WRITER AS WRITER
, NVL(TO_CHAR(T.REPORT_DATE, 'YYYY-MM-DD'), '') AS REPORT_DATE
, T.STATUS_DATE AS STATUS_DATE
, T.STATUS_STATE AS STATUS_STATE
FROM
(
SELECT V.REPORT_NUM AS REPORT_NUM, V.REASON AS REASON, V.REPORT_TITLE AS REPORT_TITLE, V.TYPE AS TYPE
, ( SELECT USER_NAME
    FROM USERS
    WHERE SIGN_NUM = V.WRITER
   ) AS WRITER
, V.REPORT_DATE AS REPORT_DATE, NVL(TO_CHAR(V.STATUS_DATE, 'YYYY-MM-DD'), '') AS STATUS_DATE
, CASE WHEN V.STATUS_NUM = 0 THEN '미처리' 
       ELSE '처리완료' END AS STATUS_STATE 
FROM VIEW_REPORTLIST V
ORDER BY V.REPORT_DATE DESC
)T
WHERE T.STATUS_STATE=#{cstatusnum }
) DATA
) R
WHERE RNUM <![CDATA[>=]]> #{start} AND RNUM <![CDATA[<=]]> #{end}
</select>

<select id="list" resultType="com.fp.dto.ReportDTO" parameterType="java.lang.String">
SELECT RNUM, REPORT_NUM, REASON, REPORT_TITLE, TYPE, WRITER, REPORT_DATE, STATUS_DATE, STATUS_STATE
FROM 
(
SELECT ROWNUM AS RNUM, DATA.*
FROM
(
SELECT V.REPORT_NUM AS REPORT_NUM, V.REASON AS REASON, V.REPORT_TITLE AS REPORT_TITLE, V.TYPE AS TYPE
, ( SELECT USER_NAME
    FROM USERS
    WHERE SIGN_NUM = V.WRITER
   ) AS WRITER
, NVL(TO_CHAR(V.REPORT_DATE, 'YYYY-MM-DD'), '') AS REPORT_DATE
, NVL(TO_CHAR(V.STATUS_DATE, 'YYYY-MM-DD'), '') AS STATUS_DATE
, CASE WHEN V.STATUS_NUM = 0 THEN '미처리' 
       ELSE '처리완료' END AS STATUS_STATE 
FROM VIEW_REPORTLIST V
ORDER BY V.REPORT_DATE DESC
) DATA
) R
WHERE RNUM <![CDATA[>=]]> #{start} AND RNUM <![CDATA[<=]]> #{end}
</select>

<select id="searchList" resultType="com.fp.dto.ReportDTO">
SELECT T.REPORT_NUM AS REPORT_NUM, T.REASON AS REASON, T.REPORT_TITLE AS REPORT_TITLE, T.TYPE AS TYPE
, T.WRITER AS WRITER
, NVL(TO_CHAR(T.REPORT_DATE, 'YYYY-MM-DD'), '') AS REPORT_DATE
, T.STATUS_DATE AS STATUS_DATE
, T.STATUS_STATE AS STATUS_STATE
FROM
(
SELECT V.REPORT_NUM AS REPORT_NUM, V.REASON AS REASON, V.REPORT_TITLE AS REPORT_TITLE, V.TYPE AS TYPE
, ( SELECT USER_NAME
    FROM USERS
    WHERE SIGN_NUM = V.WRITER
   ) AS WRITER
, V.REPORT_DATE AS REPORT_DATE, NVL(TO_CHAR(V.STATUS_DATE, 'YYYY-MM-DD'), '') AS STATUS_DATE
, CASE WHEN V.STATUS_NUM = 0 THEN '미처리' 
       ELSE '처리완료' END AS STATUS_STATE 
FROM VIEW_REPORTLIST V
)T
WHERE T.WRITER LIKE '%'||#{keyword}||'%'
</select>

<select id="searchReportNum" parameterType="java.lang.String" resultType="com.fp.dto.ReportDTO">
SELECT V.TYPE AS TYPE, V.REPORT_NUM AS REPORT_NUM
, (SELECT USER_ID
   FROM USERS
  WHERE SIGN_NUM = V.REPORTER) AS USER_ID
, (SELECT USER_NAME
  FROM USERS
  WHERE SIGN_NUM = V.REPORTER) AS USER_NAME
, V.REASON AS REASON
, V.REPORT_TITLE AS REPORT_TITLE
, NVL(V.REPORT_CONTENT, '') AS REPORT_CONTENT
FROM VIEW_REPORTLIST V 
WHERE V.TYPE = #{type}
AND V.REPORT_NUM = #{report_num}
ORDER BY V.REPORT_NUM
</select>

<insert id="bStatusInsert">
INSERT INTO BREPORT_STATUS(BSTATUS_NUM, ADMIN_NUM, BREPORT_NUM, TYPE_NUM)
VALUES(BREPORT_STATUS_SEQ.NEXTVAL, #{admin_num}, #{report_num}, #{type_num})
</insert>

<insert id="cStatusInsert">
INSERT INTO CREPORT_STATUS(CSTATUS_NUM, ADMIN_NUM, CREPORT_NUM, TYPE_NUM)
VALUES(CREPORT_STATUS_SEQ.NEXTVAL, #{admin_num}, #{report_num}, #{type_num})
</insert>

<insert id="coStatusInsert">
INSERT INTO COREPORT_STATUS(COSTATUS_NUM, ADMIN_NUM, COREPORT_NUM, TYPE_NUM)
VALUES(COREPORT_STATUS_SEQ.NEXTVAL, #{admin_num}, #{report_num}, #{type_num})
</insert>

<select id="count" resultType="java.lang.Integer">
SELECT COUNT(TYPE) AS COUNT
FROM VIEW_REPORTLIST
</select>

<select id="noneChekcount" resultType="java.lang.Integer">
SELECT NVL(MAX(ROWNUM), 0) AS COUNT
FROM
(
SELECT V.REPORT_NUM AS REPORT_NUM, V.REASON AS REASON, V.REPORT_TITLE AS REPORT_TITLE, V.TYPE AS TYPE
, ( SELECT USER_NAME
    FROM USERS
    WHERE SIGN_NUM = V.WRITER
   ) AS WRITER
, V.REPORT_DATE AS REPORT_DATE, NVL(TO_CHAR(V.STATUS_DATE, 'YYYY-MM-DD'), '') AS STATUS_DATE
, CASE WHEN V.STATUS_NUM = 0 THEN '미처리' 
       ELSE '처리완료' END AS STATUS_STATE 
FROM VIEW_REPORTLIST V
)T
WHERE T.STATUS_STATE='미처리'
</select>

<select id="Checkcount" resultType="java.lang.Integer">
SELECT NVL(MAX(ROWNUM), 0) AS COUNT
FROM
(
SELECT V.REPORT_NUM AS REPORT_NUM, V.REASON AS REASON, V.REPORT_TITLE AS REPORT_TITLE, V.TYPE AS TYPE
, ( SELECT USER_NAME
    FROM USERS
    WHERE SIGN_NUM = V.WRITER
   ) AS WRITER
, V.REPORT_DATE AS REPORT_DATE, NVL(TO_CHAR(V.STATUS_DATE, 'YYYY-MM-DD'), '') AS STATUS_DATE
, CASE WHEN V.STATUS_NUM = 0 THEN '미처리' 
       ELSE '처리완료' END AS STATUS_STATE 
FROM VIEW_REPORTLIST V
)T
WHERE T.STATUS_STATE='처리완료'
</select>

</mapper>





